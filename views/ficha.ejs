<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title><%= truck ? ('Ficha ' + truck.placa) : 'Ficha' %></title>
  <link rel="stylesheet" href="/styles.css"/>
</head>
<body>
  <main class="wrap">
    <div class="header">
      <h2 style="margin:0"><%= truck ? ('Placa ' + truck.placa) : 'Placa no encontrada' %></h2>
      <div style="display:flex;gap:8px">
        <a class="btn" href="/">Inicio</a>
        <a class="btn" href="/admin/login">Admin</a>
      </div>
    </div>

    <% if (!truck) { %>
      <section class="card">
        <p class="muted">No existe información para esta placa.</p>
      </section>
    <% } else { %>

      <% if (typeof enviado !== 'undefined' && enviado) { %>
        <div class="alert" style="margin-bottom:12px">
          <strong>¡Gracias!</strong> Tu reporte fue enviado.
        </div>
      <% } %>
      <% if (typeof error !== 'undefined' && error) { %>
        <div class="alert warn" style="margin-bottom:12px">
          <strong>Ups…</strong> Escribe el mensaje del reporte.
        </div>
      <% } %>

      <% if (avisos && avisos.length) { %>
        <div class="alert warn">
          <strong>Avisos:</strong> Hay <%= avisos.length %> documento(s) vencidos o por vencer.
        </div>
      <% } %>

      <!-- Portada + QR + datos básicos -->
      <section class="card">
        <div style="display:grid;grid-template-columns:160px 1fr 160px;gap:12px;align-items:center">
          <div>
            <% if (truck.foto) { %>
              <img src="<%= truck.foto %>" alt="Portada" style="width:100%;height:120px;object-fit:cover;border:1px solid #20304d;border-radius:8px" loading="lazy"/>
            <% } else { %>
              <div class="muted" style="border:1px dashed #20304d;border-radius:8px;height:120px;display:flex;align-items:center;justify-content:center">Sin portada</div>
            <% } %>
          </div>

          <div>
            <div style="display:flex;align-items:center;gap:8px;flex-wrap:wrap">
              <h3 style="margin:0"><%= truck.marca || '-' %> <%= truck.modelo || '' %></h3>
              <% if (truck.anio) { %><span class="badge"><%= truck.anio %></span><% } %>
            </div>
            <div class="muted" style="margin-top:4px">
              Unidad: <b><%= truck.unidad || '-' %></b> · CEDIS: <b><%= truck.cedis || '-' %></b> · VIN: <b><%= truck.vin || '-' %></b>
            </div>

            <% if ((truck.notas||[]).length) { %>
              <div style="margin-top:6px">
                <span class="muted">Notas:</span>
                <ul style="margin:6px 0 0 16px">
                  <% (truck.notas||[]).forEach(n => { %>
                    <li><%= n %></li>
                  <% }) %>
                </ul>
              </div>
            <% } %>

            <% if (truck.telefono_quejas) { %>
              <div style="margin-top:8px">
                <a class="btn" href="tel:<%= truck.telefono_quejas.replace(/\s+/g,'') %>">Llamar: <%= truck.telefono_quejas %></a>
              </div>
            <% } %>
          </div>

          <div style="text-align:right">
            <div class="muted" style="font-size:.8rem;margin-bottom:6px">QR de esta ficha</div>
            <!-- Cache-busting para evitar QR viejo (localhost) -->
            <!-- Ahora -->
<img src="/qrimg/<%= encodeURIComponent(truck.placa) %>.png?v=3"
     alt="QR" style="width:140px;height:140px;border:1px solid #20304d;border-radius:8px;object-fit:contain"/>

          </div>
        </div>
      </section>

      <!-- Documentos -->
      <section class="card">
        <h3 style="margin-top:0">Permisos / Documentos</h3>
        <% if (docs && docs.length) { %>
          <div style="overflow:auto">
            <table class="table">
              <thead>
                <tr>
                  <th>Categoría</th>
                  <th>Título</th>
                  <th>Vence</th>
                  <th>Estado</th>
                  <th>Archivo</th>
                </tr>
              </thead>
              <tbody>
                <% for (var i=0;i<docs.length;i++){ var d = docs[i]; %>
                  <tr>
                    <td><%= d.categoria %></td>
                    <td><%= d.titulo %></td>
                    <td><%= d.fecha_vencimiento || '-' %></td>
                    <td>
                      <% if (d.estado==='vencido') { %>
                        <span class="badge danger">Vencido</span>
                      <% } else if (d.estado==='por-vencer') { %>
                        <span class="badge warn">Por vencer (<%= d.dias %> d)</span>
                      <% } else if (d.estado==='vigente') { %>
                        <span class="badge ok">Vigente</span>
                      <% } else { %>
                        <span class="badge">Sin fecha</span>
                      <% } %>
                    </td>
                    <td>
                      <% if (d.url) { %>
                        <a href="<%= d.url %>" target="_blank" rel="noopener noreferrer">Ver</a><br/>
                        <img src="<%= d.url %>" alt="doc" style="max-width:120px;max-height:80px;object-fit:cover;border:1px solid #20304d;border-radius:6px;margin-top:4px" loading="lazy"/>
                      <% } else { %>
                        <span class="muted">—</span>
                      <% } %>
                    </td>
                  </tr>
                <% } %>
              </tbody>
            </table>
          </div>
        <% } else { %>
          <p class="muted">Aún no hay documentos cargados.</p>
        <% } %>
      </section>

      <!-- Galería -->
      <section class="card">
        <h3 style="margin-top:0">Galería</h3>
        <% if (fotos && fotos.length) { %>
          <div class="gallery">
            <% for (var i=0;i<fotos.length;i++){ var u=fotos[i]; %>
              <figure class="fig">
                <img class="responsive" src="<%= u %>" loading="lazy" />
              </figure>
            <% } %>
          </div>
        <% } else { %>
          <p class="muted">Sin imágenes.</p>
        <% } %>
      </section>

      <!-- Reporte público -->
      <section class="card">
        <h3 style="margin-top:0">¿Deseas dejar un reporte?</h3>
        <form method="post" action="/c/<%= encodeURIComponent(truck.placa) %>/report">
          <!-- Honeypot anti-spam -->
          <input type="text" name="empresa" style="display:none" tabindex="-1" autocomplete="off"/>

          <div class="grid">
            <div>
              <label>Tipo de reporte
                <select name="tipo">
                  <option>Queja</option>
                  <option>Recomendación</option>
                  <option>Otro</option>
                </select>
              </label>
            </div>
            <div>
              <label>Nombre (opcional)
                <input name="nombre" placeholder="Tu nombre"/>
              </label>
            </div>
            <div>
              <label>Teléfono (opcional)
                <input name="telefono" placeholder="Ej: 8888-8888"/>
              </label>
            </div>
            <div>
              <label>Email (opcional)
                <input type="email" name="email" placeholder="tu@correo.com"/>
              </label>
            </div>
          </div>

          <label>Mensaje (obligatorio)
            <textarea name="mensaje" rows="4" placeholder="Escribe tu reporte..." required></textarea>
          </label>

          <button class="btn" type="submit">Enviar reporte</button>
        </form>
      </section>

    <% } %>
  </main>
</body>
</html>
